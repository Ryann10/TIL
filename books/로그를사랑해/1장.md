# 로그를 사랑해

로그는 시스템의 핵심적인 추상체abstraction

운용 중인 장비들의 특성을 이해하기 위한 쿼리와 그래프의 입력 값으로 쓰이는 것이 목적

로그는 시간순으로 덧붙이기만 가능한append_only 레코드 시퀀스record sequence로, 데이터베이스나 시스템 분야에서 커밋 로그commit log/저널journal과 가깝고 일반적인 개념이다.

## 데이터베이스에서의 로그

[IBM System R](https://people.eecs.berkeley.edu/~brewer/cs262/SystemR.pdf) 시절 로그는 DB에서 장애가 발생하면 데이터 구조와 인덱스를 동기화 시킬 용도로 사용

데이터 구조에 어떤 변경을 하기 직전 변경될 레코드 이력을 남겨두기 위해 데이터베이스에서 로그를 활용하기 시작

로그는 발생한 일을 기록한 레코드고, 각 테이블이나 인덱스는 이러한 이력을 유용한 방향으로 투영시킨 결과물

시스템 장애가 발생할 때 다른 영속적인persistent 데이터 구조를 복구하는 가장 확실한 소스

이후 로그는 DB ACID를 구현하기 위한 용도에서 DB간 데이터를 복제하는 도구로 사용 범위가 확대
> replica database를 동기화하기 용도로 사용

로그 용도

- 다른 사본으로 데이터를 전송하기 위한 Pub/Sub 장치
- 여러 사본에 순서대로 업데이트를 적용하기 위한 데이터 동기화 장치

## 분산 시스템에서의 로그

분산 시스템에서 로그 중심적log-centrirc인 접근 방법은 기계 복제 원리machine replication principle라는 단순한 이론에서 비롯됨

> 2개의 똑같은 확정적deterministic 프로세스가 똑같은 상태에서 시작하여 똑같은 입력을 똑같은 순서대로 받는다면, 똑같은 결과를 산출하고 똑같은 상태로 종료될 것이다.

기계 복제 원리는 2개의 확정적 코드에 똑같은 로그를 입력하면 똑같은 순서대로 똑같은 결과가 산출 된다는 것이다.

분산 컴퓨팅에서는 다수의 기계가 똑같은 일을 하도록 같 프로세스에 똑같은 로그를 입력하는 식으로 구현하는 것이다.

로그의 역할은 자신을 입력받아 처리할 각 사본이 동기화될 수 잇도록 입력 스트림에서 모든 비확정성nondeterminism을 짜내는 것이다.

이산적인discrete 로그 엔트리 번호가 사본의 상태를 나타내는 시계가 된다. 번호 하나로 모든 사본의 상태를 표시할 수 있고, 해당 사본에서 가장 마지막으로 처리한 로그 엔트리의 타임 스탬프가 되는 것이다. 로그와 결합한 타임스탬프로 사본의 전체 상태도 포착 가능해진다. 단순히 기계의 로컬 시간이 아닌, 이산적이고discrete, 이벤트 구동event-driven 적인 시간을 기준으로 다른 기계 간의 상태를 쉽게 비교할 수 있다.

### 로그 중심 설계 다양성

- 서버 요청을 로깅하여 각 복제 프로세스가 독립적으로 처리
- 처리 인스턴스를 하나 띄워두고 서비스 응답 과정에서 변경된 상태를 로깅

이론적으로 x86 기계어 명령이나 호출한 메소드명, 파라미터까지도 로깅해 두었다가 각 사본에서 실행할 수도 있음

#### 데이터베이스에서 기술하는 방식

- 물리적 로깅: 테이블의 로우 단위row-base로 변경 내용을 기록하는 것
- 논리적 로깅: 변경된 로우 뿐만 아니라 변경을 일으킨 SQL 명령문까지 로그에 포함하는 구문statement 로깅

#### 프라이머리-백업primary-backup 모델

상태 기계 복제 모델 외 처리와 복제를 다루는 방식

복제 프로세스 중 하나를 리더로 지정하여 리더 프로세스가 접수 순서대로 요청을 처리하고 그 결과 발생한 상태 변화를 로깅하면, 다른 복제 프로세스들은 리더가 로깅한 상태를 스스로 적용하여 동기화

![Primary-backup](https://www.oreilly.com/library/view/i-heart-logs/9781491909379/assets/ihtl_0103.png)

### 로그와 일치화

분산 로그는 일치화consensus 문제를 다루기 위한 데이터 구조

> Paxos 계열 알고리즘 참고. Paxos에서는 일련의 일치화 문제로 로그를 모델링한 멀티 팍소스multi-paxos 라는 프로토콜로 확장하여, 로그의 한 슬롯당 한 번씩 일치화를 수행. ZAB, RAFT, Viewstamped Replication 등은 동기화 로그를 분산시켜 보관하는 문제를 직접 다룬 프로토콜
