# 대규모 마이크로서비스

## 장애는 어디에서나 발생한다.

### 피터 도이취(L Peter Deutsch)의 [분산 컴퓨팅의 오류](https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing)

- 네트워크는 신뢰할 수 없다.
- 장애의 원인을 제한하기 위해 최선을 다하지만 특정 규모에서의 장애는 피할 수 없다.
  - 하드 디스크는 전보다 더 안정적이지만 결국에는 고장날 것이다.
  - 더 많은 하드 디스크가 있다면 개별 장치에 대한 장애 가능성도 높아지므로, 대규모 환경에서 필연적이다.
- 실패의 가능성을 수용하는 편이 더 낫다.
  - 예상치 못한 중단(outage)보다 계획된 중단이 훨씬 처리하기 쉽기 때문
- 어떤 것이든 고장날 수 있다는 가정을 명심해야 한다
  - 문제의 해결 방법을 다르게 생각하도록 만든다.

## 얼마나 많아야 너무 많은 건가?

### 교차 기능 요구 사항

부하와 장애를 더 잘 처리하기 위해 시스템이 확장 방법을 고려해야 한다면 아래 요구 사항을 이해 하는 것이 중요하다

- 응답시간/지연시간
  - 증가하는 부하가 응답시간에 어떻게 영향을 주는지 이해하기 위해 각각 다른 수의 사용자로 측정하는 것이 유용하다.
  - 네트워크의 특성 상 항상 이상치가 발생하므로 관찰할 응답의 특정 백분위수를 목표로 설정하는 것이 유용하다.
  - 예: 웹사이트가 초당 200개의 동시 접속수를 처리할 때 응답시간의 90%가 2초 미만을 유지할 것으로 예상됩니다.
- 가용성
  - 서비스가 응답하든 안 하든 사용할 수 있어야 한다. 다운타임 기간의 측정은 실제로 사건 기록 리포팅 관점에서 더 유용하다
- 데이터의 내구성
  - 얼마나 많은 데이터 손실이 허용 가능한가?
  - 얼마나 오랜 기간 데이터를 보관해야 하는가?
  - 예: 사용자 세션로그의 보관 기간은 1년 또는 이하가 될 수 있지만, 금융 거래 기록은 수년 동안 보관해야 할 수도 있다.

## 기능 분해

회복력 있는 시스템 구축에서 가장 중요한 것 중 하나는 안전하게 기능을 분해할 수 있는 능력이다.

## 아키텍쳐 안전 조치 (Architectural Safety Measure)

나쁜 시민 한 명이 시스템 세상 전체를 망가뜨리지 않도록 여러분 시스템에 표준화를 강력히 고려해야 한다.

### [교살자 패턴(Strangler Pattern)](https://docs.microsoft.com/ko-kr/azure/architecture/patterns/strangler)

- 예: 하위 시스템에 문제가 발생하여 전체 시스템을 다운시키는 장애 전파에 취약한 시스템
  - 외부의 모든 요청에 대해 하나의 HTTP 커넥션을 공유하고 있었음
    - 모든 서비스가 정상인 상태에서도 느린 서비스 하나로 모든 가용한 작업자 스레드가 소진 될 수 있다는 것을 의미
      - 타임아웃 올바르게 설ㄹ정
      - 커넥션 풀을 분리하기 위한 격벽(bulkhead) 구현
      - 정상 동작하지 않는 시스템은 애초에 호출하지 않도록 회로 차단기 구현

## [안티프래질 조직](https://queue.acm.org/detail.cfm?id=2499552)

- 카오스 몽키
  - 하루 중 특정 시간 동안 임의로 머진의 전원 꺼버리기
- 카오스 고릴라
  - 전체 가용성 센터(AWS의 데이터 센터)를 검토하는데 사용
- 레이턴시 몽키
  - 머신 간의 느린 네트워크 접속 상황을 시뮬레이션
- 발생한 장애가 주는 교훈의 중요성과 실수를 해도 비난하지 않는 문화를 수용하는 중요성 잘 알기
- 분산 시스템에서 요구되는 마인드셋의 전환을 이해하는 것은 중요하다
  - 모든 것은 결국 고장나게 되어 있다.

### 타임아웃

- 호출이 실패했다고 판단하는 데 너무 오래 걸리면 전체 시스템이 느려질 수 있다. 너무 빨리 타임아웃하면 동작했을지도 모르는 호출을 실패로 고려할 것이다.

### 회로 차단기

- 하위 자원에 대한 특정 수의 요청이 실패한 후 회로 차단기가 끊어지고 이후의 모든 요청은 회로 차단기가 끊어진 상태이므로 바로 실패한다. 특정 시간 이후 클라이언트는 하위 서비스가 복구되었는지 확인하기 위해 요청 몇개를 보내고 정상 응답이 오면 회로 차단기를 리셋한다.

### 격벽

- 각각의 하위 커넥션마다 다른 커넥션 풀을 사용해야 한다.
- 특정 하위 서비스가 느려지게 되더라도 그 서비스의 커넥션 풀에서만 영향을 받고 다른 호출은 정상 처리되는 것을 보장할 것이다.
- 회로 차단기를 격벽을 밀봉하는 자동 메커니즘으로 간주 할 수 있다.
- 장애 전파의 위험성을 고려할 때 하위 시스템의 동기식 호출에 회로 차단기를 의무적으로 사용하는 것이 좋다.
- 넷플릭스의 히스트릭스는 리소스가 더 소진되지 않도록 특정 조건에서 요청을 거부할 수 있는 격벽을 구현하게 해준다(부하 차단, load schedding)

### 격리

- 하위 서버를 오프라인 상태로 만들 수 있는 통합 기술을 사용할 수 있다면 상위 서비스는 계획되거나 계획되지 않은 장앱로부터 영향을 받을 가능성이 낮아진다.
- 서비스 간의 격리도를 높이면 또 다른 이점이 있다. 서비스들이 서로 분리되면 서비스 소유자 간에 조율할 것도 줄어든다. 팀 간 조율이 적어질수록 더 자유롭게 서비스를 운영하고 발전시킬 수 있기 때문에 팀의 자율성은 더 높아진다.

## 멱등성

## 확장
