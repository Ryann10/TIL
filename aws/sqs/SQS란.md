# Amazon Simple Queue Service

## 장점

- 내구성: 메시지의 안전을 보장하기 위해 Amazon SQS는 여러 대의 서버에 해당 메시지를 저장합니다. 표준 대기열에서는 최소 1회의 메시지 전송을 지원하고 FIFO 대기열에서는 정확히 1회 메시지 처리를 지원합니다.
- 가용성: Amazon SQS는 중복 인프라를 사용하여 메시지에 대한 고도의 동시 액세스와 메시지 생성 및 소비에 대한 고가용성을 제공합니다.
- 확장성: Amazon SQS는 버퍼링된 각 요청을 독립적으로 처리하여 프로비저닝 지침 없이도 로드 증가 또는 급증을 처리하기 위해 투명하게 확장할 수 있습니다.
- 안정성: Amazon SQS는 처리 중에 메시지를 잠그므로 여러 생산자와 소비자가 동시에 메시지를 전송 및 수신할 수 있습니다.

## 기본 아키텍쳐

### 분산 대기열

분산 메시징 시스템에는 세 가지 주요 부분, 즉 분산 시스템의 구성 요소, 대기열(Amazon SQS 서버에 분산됨), 대기열의 메시지가 있습니다.

다음 시나리오에서 시스템에는 메시지를 대기열로 전송하고 대기열의 메시지를 수신하는 여러 구성 요소가 있습니다. 대기열(메시지 A~E 유지)은 여러 Amazon SQS 서버에서 메시지를 중복으로 저장합니다.

![그림](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/images/ArchOverview.png)

### 메시지 수명 주기

1. 생산자(구성 요소 1)는 메시지 A를 대기열로 전송하고 이 메시지는 Amazon SQS 서버에서 중복 분산됩니다.
2. 소비자(구성 요소 2)는 메시지를 처리할 준비가 되면 대기열에서 메시지를 소비하고 메시지 A가 반환됩니다. **메시지 A는 처리되는 동안 대기열에 그대로 남아 있고 제한 시간 초과가 지속되는 동안 후속 수신 요청으로 반환되지 않습니다.**
3. 소비자(구성 요소 2)는 대기열에서 메시지 A를 삭제하여 제한 시간 초과가 만료되면 이 메시지가 수신되어 다시 처리되지 못하도록 합니다.

![그림](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/images/sqs-message-lifecycle-diagram.png)


## 작동 방식

### Standard Queues

- 메시지 정렬
  - 표준 대기열을 통해 메시지 순서를 최대한 보존할 수 있지만, 2개 이상의 메시지 사본이 순서가 맞지 않게 전송될 수 있습니다.
- 최소 1회 전송
  - Amazon SQS는 중복성과 고가용성을 위해 여러 대의 서버에 메시지 사본을 저장합니다. 드물게는 메시지 사본을 받거나 삭제할 때 메시지 사본을 저장하는 서버 중 하나를 사용할 수 없을 수도 있습니다. 이 문제가 발생할 경우 사용 불가능한 해당 서버에서 메시지의 사본이 삭제되지 않으며, 메시지를 받을 때 해당 메시지 사본을 다시 가져올 수 있습니다. 따라서 애플리케이션이 멱등성이 되도록 설계해야 합니다(다시 말해 동일한 메시지를 두 번 이상 처리할 경우 부정적인 영향을 받지 않아야 함).
  > 멱등성 - 연산을 여러 번 적용하더라도 결과가 달라지지 않는 성질을 의미
- 짧은 폴링을 사용한 메시지 사용
  - 대기열에서 메시지를 사용하는 프로세스는 짧은(기본 동작) 폴링, 기본 동작 또는 긴 폴링 중 어떤 것을 사용하는지에 따라 다릅니다. 긴 폴링에 대한 자세한 내용은 Amazon SQS 긴 폴링 단원을 참조하십시오.
  - 짧은 폴링을 사용하여 대기열에서 메시지를 사용하면, Amazon SQS는 가중치 기반 무작위 배포를 기반으로 이 서버의 하위 세트를 샘플링하고 해당 서버에서만 메시지를 반환합니다. 또한, 특정 수신 요청은 모든 메시지를 반환하지 않을 수도 있습니다. 하지만 대기열의 메시지 수가 1,000개 미만인 경우 이후 요청은 메시지를 반환합니다. 대기열에서 계속 사용할 경우 Amazon SQS가 서버를 모두 샘플링하며, 사용자는 메시지를 모두 받게 됩니다.
  > 계속 사용한다는 의미가 가지고 와야할 메시지 수보다 샘플링 한 서버에서 가져오는 메시지 수가 적게 되는 경우 다시 전체 서버를 샘플링한다는 의미 인 듯
  - 다음 그림은 시스템 구성 요소 중 하나가 수신 요청을 한 후 표준 대기열에서 반환되는 메시지의 짧은 폴링 동작을 보여줍니다. Amazon SQS는 몇 개의 서버(회색)를 샘플링하고 이들 서버에서 메시지 A, C, D, B를 반환합니다. 메시지 E는 이 요청에서 반환되지 않지만 이후 요청에서 반환됩니다. ![그림](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/images/ArchOverview_Receive.png)

### 긴 폴링

- 응답을 전송하기 전에 대기열에서 메시지를 사용할 수 있을 때까지 Amazon SQS를 대기시켜 빈 응답을 제거합니다. 연결 시간이 초과되지 않은 경우, ReceiveMessage 요청에 대한 응답은 하나 이상의 사용 가능한 메시지부터 ReceiveMessage 작업에 지정된 최대 메시지 개수까지 포함합니다.
- (하위 세트가 아닌) 모든 Amazon SQS 서버를 쿼리하여 거짓의 빈 응답을 제거합니다.
- 사용 가능한 즉시 메시지를 반환합니다.

#### 짧은 폴링과 차이점

- 짧은 폴링은 기본적으로 서버의 하위 세트(가중치 기반 부작위 배포 기반)만을 쿼리하여 응답에 메시지를 사용할 수 있는지 여부를 결정합니다.

### 제한 시간 초과

소비자가 대기열에서 메시지를 수신하고 처리하면 메시지는 계속 대기열에 있습니다. Amazon SQS는 메시지를 자동으로 삭제하지 않습니다. Amazon SQS는 분산 시스템이므로 소비자가 메시지를 실제로 받는지 보장할 수 없습니다(예를 들어, 연결 문제 또는 소비자 애플리케이션 문제로 인해). 또한, **소비자는 메시지를 수신하고 처리한 후 대기열에서 이 메시지를 삭제해야 합니다.**

![그림](https://docs.aws.amazon.com/ko_kr/AWSSimpleQueueService/latest/SQSDeveloperGuide/images/sqs-visibility-timeout-diagram.png)

메시지를 수신한 직후에는 메시지가 대기열에 그대로 있습니다. **다른 소비자가 메시지를 다시 처리할 수 없도록 하기 위해 Amazon SQS에서는 다른 소비자가 Amazon SQS에서 메시지를 수신 및 처리할 수 없는 기간인 제한 시간 초과를 설정합니다.** 메시지의 기본 제한 시간은 30초입니다. 최대는 12시간입니다.

- 이동 중 메시지
  - SQS 메시지의 기본 상태는 1. 생산자가 대기열로 전송, 2. 소비자가 대기열에서 수신, 3. 대기열에서 삭제 세가지로 존재한다.
  - 메시지는 소비자가 수신했지만, 대기열에서 삭제되지 않을 상태일 때(즉, 상태 2와 3 사이) **이동 중 상태**로 간주됩니다.
- 제한 시간 초과 설정
  - 제한 시간 초과는 Amazon SQS가 메시지를 반환할 때 시작됩니다. 이 시간 동안 소비자는 메시지를 처리하고 삭제합니다. 하지만 소비자가 메시지를 삭제하기 전에 실패할 경우 제한 시간 초과가 만료되기 전에 시스템에서 해당 메시지에 대한 DeleteMessage 작업을 호출하지 않으면 다른 소비자가 메시지를 볼 수 있게 되고 메시지가 다시 수신됩니다. 메시지가 한 번만 수신되어야 하는 경우 소비자는 제한 시간 초과 기간 내에 메시지를 삭제해야 합니다.
  - 메시지를 수신할 때 전체 대기열 제한 시간을 변경하지 않고도 반환된 메시지에 대해 특별한 제한 시간 초과를 설정할 수도 있습니다.
  - 메시지를 처리하는 데 시간이 얼마나 걸릴지 모르는 경우 다음과 같이 소비자 프로세스에 대한 하트비트를 생성하십시오. 초기 제한 시간 초과(예: 2분)를 지정한 다음 소비자가 메시지 작업을 계속하는 동안 제한 시간 초과를 1분마다 2분씩 연장합니다.
- 메시지에 대한 제한 시간 초과 변경
  - 대기열에서 메시지를 수신하여 처리하기 시작하다 보면 이 대기열의 표시 제한 시간이 부족해질 수 있습니다(처리한 메시지를 삭제해야 하는 경우도 있음). 메시지의 제한 시간을 단축하거나 늘리기 위해 ChangeMessageVisibility 작업을 사용하여 새 제한 시간 값을 지정할 수 있습니다.
  - 예를 들어 대기열의 시간 제한이 60초이고 메시지를 받은 뒤로 15초가 흘렀는데 VisibilityTimeout을 10초로 설정하여 ChangeMessageVisibility 호출을 보내면, ChangeMessageVisibility 호출 시점으로부터 10초를 세기 시작합니다. 따라서 표시 제한 시간(총 25초)을 처음 변경하고 10초가 지난 뒤에 이를 변경하려 하거나 메시지를 삭제하려고 하면 오류가 발생합니다.
  > 새로운 제한 시간은 ChangeMessageVisibility 작업을 호출한 시간부터 적용됩니다. 또한, 새 제한 시간은 특정 메시지 수신에만 적용됩니다. ChangeMessageVisibility는 메시지 수신이나 이후 대기열의 제한 시간에 영향을 미치지 않습니다.
- 메시지에 대한 제한 시간 초과 종료
  - 대기열에서 메시지를 수신할 때 실제로 해당 메시지를 처리 및 삭제하지 않아도 됨을 알 수 있습니다. Amazon SQS를 통해 특정 메시지의 제한 시간 초과를 종료할 수 있습니다. 그리고 나면 메시지가 시스템의 다른 구성 요소에 즉시 표시되어 처리할 수 있습니다.
